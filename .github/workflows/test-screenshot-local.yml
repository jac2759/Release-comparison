name: Test Screenshot Comparison (Local)

on:
  workflow_dispatch:
    inputs:
      threshold:
        description: 'Difference threshold percentage'
        required: false
        type: number
        default: 20
      build_mode:
        description: 'Build mode'
        required: false
        type: string
        default: 'Test'

jobs:
  screenshot-comparison:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install playwright pixelmatch pngjs

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y libnspr4 libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libxkbcommon0 libatspi2.0-0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 libasound2

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Wait for deployment
        run: |
          echo "Waiting 5 seconds for deployment to be ready..."
          sleep 5

      - name: Take screenshot
        run: |
          mkdir -p screenshots
          node -e "
          const { chromium } = require('playwright');
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.setViewportSize({ width: 1920, height: 1080 });
            await page.goto('https://jac2759.github.io/Release-comparison/', { waitUntil: 'networkidle' });
            await page.waitForTimeout(2000);
            await page.screenshot({ 
              path: 'screenshots/current-test.png',
              fullPage: true 
            });
            await browser.close();
            console.log('Screenshot taken successfully!');
          })();
          "

      - name: List screenshots
        run: |
          ls -la screenshots/
          echo "Screenshot comparison test completed successfully!"
